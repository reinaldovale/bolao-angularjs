"use strict";angular.module("bolao.carrossel",[]).directive("carrossel",["BD","$timeout","$rootScope",function(o,e){return{restrict:"E",transclude:"true",replace:"true",templateUrl:"components/carrossel/diretivas/diretiva-carrossel.html",scope:{totalPaginas:"=",boleiro:"="},controller:["$scope",function(a){a.direcao="esquerda",a.paginas=[];var t=this,n=1,r=function(o){for(var e=0;e<a.paginas.length;e++)if(a.paginas[e].conteudo.id===o){a.paginas[e].exibir();break}};a.atualizarPagina=function(t,i){a.direcao=void 0===i?n>=t?"esquerda":"direita":i;var l=!0,s=!1;angular.forEach(a.paginas,function(o){o.conteudo.id===n&&(o.ocultar(),s=!0),o.conteudo.id===t&&(l=!1),!l&&s}),l?o.pegarRodadaES(a.boleiro.boleiro,t).then(function(o){e(function(){a.boleiro.rodadas.push(o),a.$digest(),r(t),n=t})},function(i){console.log(i),console.log("Tentando novamente..."),o.pegarRodadaES(a.boleiro.boleiro,t).then(function(o){e(function(){a.boleiro.rodadas.push(o),a.$digest(),r(t),n=t})},function(i){console.log(i),console.log("Iniciando um novo cadastro..."),o.cadastrarRodadaES(a.boleiro,t).then(function(i){0===i.jogos.length?o.pegarRodadaES(a.boleiro.boleiro,t).then(function(o){e(function(){a.boleiro.rodadas.push(o),a.$digest(),r(t),n=t})},function(o){console.log(o),console.log("Busca de rodada após cadastro falhou")}):e(function(){a.boleiro.rodadas.push(i),a.$digest(),r(t),n=t})},function(i){console.log(i),o.pegarRodadaES(a.boleiro.boleiro,t).then(function(o){e(function(){a.boleiro.rodadas.push(o),a.$digest(),r(t),n=t})},function(o){console.log(o),console.log("Click novamente no número da rodada")})})})}):e(function(){r(t),n=t})},a.ehPaginaAtual=function(o){return n===o},a.proximaPagina=function(){var o=n,e=o<a.totalPaginas?++o:1;a.atualizarPagina(e,"direita")},a.paginaAnterior=function(){var o=n,e=o>1?--o:a.totalPaginas;a.atualizarPagina(e,"esquerda")},t.adicionarPagina=function(o){1===n&&o.exibir(),a.paginas.push(o)}}]}}]).directive("pagina",function(){return{require:"^carrossel",restrict:"E",transclude:"true",replace:"true",scope:{conteudo:"="},link:function(o,e,a,t){o.exibir=function(){o.visivel=!0,o.detalheVisivel=!1},o.ocultar=function(){o.visivel=!1,o.detalheVisivel=!1},o.alternarDetalhe=function(){o.detalheVisivel=!o.detalheVisivel},o.ocultar(),t.adicionarPagina(o)},templateUrl:"components/carrossel/diretivas/diretiva-paginas.html"}}),angular.module("bolao.acordeon",[]).directive("acordeon",function(){return{restrict:"E",transclude:"true",replace:"true",templateUrl:"components/acordeon/diretivas/diretiva-acordeon.html",scope:"true",controller:["$scope",function(o){o.itens=[];var e=this,a=[],t=2,n=0,r=[],i=2,l=0,s=0,c=function(o){if(i>l){for(var e=0;e<r.length;e++)if(r[e].boleiro.pontos===o.boleiro.pontos&&r[e].boleiro.placares===o.boleiro.placares){l--;break}o.tipo="item-rebaixado",l++,r.push(o)}else{for(var a=!1,e=0;e<r.length;e++)if(r[e].boleiro.pontos===o.boleiro.pontos&&r[e].boleiro.placares===o.boleiro.placares){a=!0;break}if(a)o.tipo="item-rebaixado",r.push(o);else{var t=r.filter(function(e){return e.boleiro.pontos>o.boleiro.pontos||e.boleiro.pontos===o.boleiro.pontos&&e.boleiro.placares>o.boleiro.placares});if(t.length>0){for(var n=t[0].boleiro.pontos,s=t[0].boleiro.placares,e=1;e<t.length;e++)(t[e].boleiro.pontos>n||t[e].boleiro.pontos===n&&t[e].boleiro.placares>s)&&(n=t[e].boleiro.pontos,s=t[e].boleiro.placares);r=r.filter(function(o){var e=!0;return o.boleiro.pontos===n&&o.boleiro.placares===s&&(o.tipo="",e=!1),e}),o.tipo="item-rebaixado",r.push(o)}}}},d=function(o){if(t>n){for(var e=0;e<a.length;e++)if(a[e].boleiro.pontos===o.boleiro.pontos&&a[e].boleiro.placares===o.boleiro.placares){n--;break}o.tipo="item-premiado",n++,a.push(o)}else{for(var r=!1,e=0;e<a.length;e++)if(a[e].boleiro.pontos===o.boleiro.pontos&&a[e].boleiro.placares===o.boleiro.placares){r=!0;break}if(r)o.tipo="item-premiado",a.push(o);else{var i=a.filter(function(e){return e.boleiro.pontos<o.boleiro.pontos||e.boleiro.pontos===o.boleiro.pontos&&e.boleiro.placares<o.boleiro.placares});if(i.length>0){for(var l=i[0].boleiro.pontos,s=i[0].boleiro.placares,e=1;e<i.length;e++)(i[e].boleiro.pontos<l||i[e].boleiro.pontos===l&&i[e].boleiro.placares<s)&&(l=i[e].boleiro.pontos,s=i[e].boleiro.placares);a=a.filter(function(o){var e=!0;return o.boleiro.pontos===l&&o.boleiro.placares===s&&(o.tipo="",c(o),e=!1),e}),o.tipo="item-premiado",a.push(o)}else c(o)}}};e.adicionarItem=function(e){d(e),o.itens.push(e)},e.abrir=function(e){e===s?o.itens[s].visivel?o.itens[e].ocultar():o.itens[e].exibir():(o.itens[s].ocultar(),o.itens[e].exibir()),s=e}}]}}).directive("item",["BD",function(o){return{require:"^acordeon",restrict:"E",transclude:"true",replace:"true",scope:{boleiro:"=",indice:"@"},link:function(e,a,t,n){e.direcao="esquerda",e.exibir=function(){e.visivel=!0,e.situacao="item-aberto"},e.abrir=function(a){var t=1;e.boleiro.rodadas=e.boleiro.rodadas||[];var r=e.boleiro.rodadas.filter(function(o){return o.id===t})[0];r||o.pegarRodadaES(e.boleiro.boleiro,t).then(function(o){e.boleiro.rodadas.push(o)},function(o){console.log(o)}),n.abrir(a)},e.ocultar=function(){e.visivel=!1,e.situacao="item-fechado"},e.ocultar(),n.adicionarItem(e)},templateUrl:"components/acordeon/diretivas/diretiva-item.html"}}]),angular.module("bolao",["bolao.carrossel","bolao.acordeon","ngTouch","googleOauth"]),angular.module("bolao").factory("BD",["$http","$templateCache","$q",function(o,e,a){var t=function(o){return{method:o.method?o.method:"POST",url:o.url?"https://fili-us-east-1.searchly.com/bolao"+o.url:"https://fili-us-east-1.searchly.com/bolao/jogo",data:o.dados?o.dados:"",headers:{Authorization:"Basic c2l0ZTpjZGFhOTgyYjE4MWM0MTRiZTg3Yzk1ODdhOThkMjg5NA=="},cache:e}},n={aggs:{boleiros:{terms:{field:"boleiro.raw",size:0,order:{pontos:"desc",placares:"desc"}},aggs:{foto:{terms:{field:"foto.raw"}},pontos:{sum:{script:"if(doc['gaba_manda'].empty||doc['gaba_visit'].empty||doc['mandante_gols'].empty||doc['visitante_gols'].empty){0}else if(doc['gaba_manda'].value==doc['mandante_gols'].value&&doc['gaba_visit'].value==doc['visitante_gols'].value){3}else if((doc['gaba_manda'].value==doc['gaba_visit'].value&&doc['mandante_gols'].value==doc['visitante_gols'].value)||(doc['gaba_manda'].value<doc['gaba_visit'].value&&doc['mandante_gols'].value<doc['visitante_gols'].value)||(doc['gaba_manda'].value>doc['gaba_visit'].value&&doc['mandante_gols'].value>doc['visitante_gols'].value)){1}else{0}"}},placares:{sum:{script:"if(doc['gaba_manda'].empty||doc['gaba_visit'].empty||doc['mandante_gols'].empty||doc['visitante_gols'].empty){0}else if(doc['gaba_manda'].value==doc['mandante_gols'].value&&doc['gaba_visit'].value==doc['visitante_gols'].value){1}else if((doc['gaba_manda'].value==doc['gaba_visit'].value&&doc['mandante_gols'].value==doc['visitante_gols'].value)||(doc['gaba_manda'].value<doc['gaba_visit'].value&&doc['mandante_gols'].value<doc['visitante_gols'].value)||(doc['gaba_manda'].value>doc['gaba_visit'].value&&doc['mandante_gols'].value>doc['visitante_gols'].value)){0}else{0}"}}}}},size:0},r={query:{bool:{must:[{term:{rodada_id:1}},{term:{"boleiro.raw":"modelo"}}]}}},i={query:{bool:{must:{term:{rodada_id:1}},must_not:[{term:{"boleiro.raw":"gabarito"}},{term:{"boleiro.raw":"modelo"}}]}}};return{cadastrarRodadaES:function(e,n){var r=this,i=a.defer();return r.pegarRodadaES("modelo",n).then(function(a){for(var l=a.jogos,s="",c=0;c<l.length;c++){var d=l[c]._source;d.boleiro=e.boleiro,d.foto=e.foto,s+='{ "index" : { "_index" : "bolao", "_type" : "jogo"} }\n{"boleiro": "'+d.boleiro+'", "foto": "'+d.foto+'", "rodada_id": "'+d.rodada_id+'", "rodadas_data": "'+d.rodadas_data+'","mandante": "'+d.mandante+'","mandante_gols": "", "visitante": "'+d.visitante+'", "visitante_gols": "", "gaba_visit": "", "gaba_manda": ""}\n'}o(t({dados:s,url:"/_bulk"})).then(function(){o(t({url:"/_flush"})).then(function(){r.pegarRodadaES(e.boleiro,n).then(function(o){i.resolve(o)},function(){i.reject("Servidor falhou ao buscar rodada de ID = "+n)})},function(){i.reject("Servidor falhou ao fazer o _flush!")})},function(){i.reject("Servidor falhou ao cadastrar rodada!")})},function(){i.reject("Servidor falhou ao buscar modelo!")}),i.promise},cadastrarBoleiroES:function(e){var n=this,r=a.defer(),i={id:1,jogos:[]};return n.pegarRodadaES("modelo",i.id).then(function(a){for(var i=a.jogos,l="",s=0;s<i.length;s++){var c=i[s]._source;c.boleiro=e.name,c.foto=e.picture,l+='{ "index" : { "_index" : "bolao", "_type" : "jogo"} }\n{"boleiro": "'+c.boleiro+'", "foto": "'+c.foto+'", "rodada_id": "'+c.rodada_id+'", "rodadas_data": "'+c.rodadas_data+'","mandante": "'+c.mandante+'","mandante_gols": "", "visitante": "'+c.visitante+'", "visitante_gols": "", "gaba_visit": "", "gaba_manda": ""}\n'}o(t({dados:l,url:"/_bulk"})).then(function(){o(t({url:"/_flush"})).then(function(){n.pegarBoleirosES().then(function(o){r.resolve(o)})})})}),r.promise},pegarBoleirosES:function(){var e=a.defer();return o(t({dados:n,url:"/jogo/_search"})).then(function(o){var a=[],t=o.data.aggregations.boleiros.buckets;a=t.map(function(o){var e=o.foto.buckets.length>0?o.foto.buckets[0].key:"";return{boleiro:o.key,foto:e,pontos:o.pontos.value,placares:o.placares.value}}),e.resolve(a)}),e.promise},pegarRodadaES:function(e,n){var i=a.defer();return r.query.bool.must[0].term.rodada_id=n,r.query.bool.must[1].term["boleiro.raw"]=e,o(t({dados:r,url:"/jogo/_search"})).then(function(o){o.data.hits.hits.length<10?i.reject("Servidor não devolveu os jogos, tente novamente"):i.resolve({id:n,jogos:o.data.hits.hits})},function(o){i.reject("Servidor falhou, tente novamente. Detalhes: "+o)}),i.promise},pegarRodadasES:function(e){var n=a.defer();return i.query.bool.must.term.rodada_id=e,o(t({dados:i,url:"/jogo/_search"})).then(function(e){if(e.data.hits.total>10){for(var r=e.data.hits.hits,l=e.data.hits.total,s=10,c=[],d=s;l>d;d+=s)c.push(o(t({dados:i,url:"/jogo/_search?from="+d})));a.all(c).then(function(o){angular.forEach(o,function(o){r=r.concat(o.data.hits.hits)}),n.resolve(r)})}else n.resolve(e.data.hits.hits)}),n.promise},atualizarEmLoteES:function(e){return o(t({dados:e,url:"/jogo/_bulk"}))}}}]).directive("menu",function(){return{restrict:"E",transclude:"true",replace:"false",templateUrl:"components/acordeon/diretivas/diretiva-menu.html",scope:"true",controller:["$scope",function(o){o.menuActive="",o.abrir=function(){o.menuActive=""===o.menuActive?"menu-active":""}}]}}).directive("stopEvent",function(){return{restrict:"A",link:function(o,e,a){e.on(a.stopEvent,function(o){o.stopPropagation()})}}}).directive("palpite",function(){return{restrict:"E",transclude:"true",replace:"false",templateUrl:"components/acordeon/diretivas/diretiva-palpite.html",scope:{jogoData:"@",gols:"="},link:function(o){{var e=new Date(Date.parse(o.jogoData));e.getTime()<=(new Date).getTime()}o.somenteLeitura=e.getTime()<=(new Date).getTime()?!0:!1}}}),angular.module("bolao").controller("NavbarCtrl",["$scope",function(o){o.date=new Date}]),angular.module("bolao").config(["TokenProvider",function(o){var e=document.URL.replace("teste.html","");o.extendConfig({clientId:"1041203641186-p7ift3msto8too87sqtkbq3so9j6qcp0.apps.googleusercontent.com",redirectUri:e+"oauth2callback.html",scopes:["https://www.googleapis.com/auth/userinfo.email"]})}]).controller("Oauth",["$rootScope","$scope","$window","$http","Token",function(o,e,a,t,n){e.authenticate=function(){var o=e.askApproval?{approval_prompt:"force"}:{};n.getTokenByPopup(o).then(function(o){n.verifyAsync(o.access_token).then(function(){t.get("https://www.googleapis.com/oauth2/v1/userinfo?access_token="+o.access_token).success(function(e){e.accessToken=o.access_token,n.set(JSON.stringify(e))})},function(){alert("Failed to verify token.")})},function(){alert("Failed to get token from popup.")})}}]).controller("ControlePrincipal",["$timeout","$scope","$http","$window","BD","Token",function(o,e,a,t,n,r){function i(o){e.boleiros=o.filter(function(o){var a=!0;return("gabarito"===o.boleiro||"modelo"===o.boleiro)&&(a=!1,"gabarito"===o.boleiro&&(e.gabarito=o)),a})}e.gabarito={},n.pegarBoleirosES().then(function(o){i(o)}),e.telaAdmin=function(){var o=r.get();o?(o=JSON.parse(r.get()),"Reinaldo Vale"===o.name?t.location.href="teste.html":alert("Voce nao tem permissao!")):alert("logar primeiro!")},e.telaCadastro=function(){var a=r.get(),t=!0;if(a){a=JSON.parse(r.get());for(var l=0;l<e.boleiros.length;l++)if(e.boleiros[l].boleiro===a.name){alert("Você já está cadastrado!"),t=!1;break}t&&(e.boleiros=n.cadastrarBoleiroES(a).then(function(a){o(function(){i(a),e.$digest()})}))}else alert("logar primeiro!")},e.atualizar=function(o,e){var a="";o.rodadas.filter(function(o){return o.id===e})[0].jogos.forEach(function(o){var e=null===o._source.visitante_gols?'""':o._source.visitante_gols,t=null===o._source.mandante_gols?'""':o._source.mandante_gols;a=a+'{ "update": {"_id":"'+o._id+'"} }\n{ "doc" : {"visitante_gols" : '+e+', "mandante_gols": '+t+'}, "detect_noop": true }\n'}),n.atualizarEmLoteES(a)},e.somenteLeitura=function(o){{var e=new Date(Date.parse(o));e.getTime()<=(new Date).getTime()}return e.getTime()<=(new Date).getTime()?!0:!1},e.ehAtualizavel=function(o){var a=o.jogos[0]._source.rodadas_data;return!e.somenteLeitura(a)}}]).controller("ControleAtualizacao",["$scope","BD",function(o,e){e.pegarRodadaES("gabarito",1).then(function(e){void 0===o.gabarito&&(o.gabarito={boleiro:"gabarito"}),void 0===o.gabarito.rodadas&&(o.gabarito.rodadas=[],o.gabarito.rodadas.push(e))}),o.atualizar=function(a){e.pegarRodadasES(a).then(function(t){var n="",r=t,i=o.gabarito.rodadas.filter(function(o){return o.id===a})[0];angular.forEach(i.jogos,function(o){var e=null===o._source.visitante_gols?'""':o._source.visitante_gols,a=null===o._source.mandante_gols?'""':o._source.mandante_gols;n=n+'{ "update": {"_id":"'+o._id+'"} }\n{ "doc" : {"visitante_gols" : '+e+', "mandante_gols": '+a+'}, "detect_noop": true }\n',angular.forEach(r,function(t){o._source.mandante===t._source.mandante&&(n=n+'{ "update": {"_id":"'+t._id+'"} }\n{ "doc" : {"gaba_visit" : '+e+', "gaba_manda": '+a+'}, "detect_noop": true }\n')})}),e.atualizarEmLoteES(n)})}}]),angular.module("googleOauth",["angularOauth"]).constant("GoogleTokenVerifier",function(o,e){var a=angular.injector(["ng"]);return a.invoke(["$http","$rootScope","$q",function(a,t,n){var r=n.defer(),i="https://www.googleapis.com/oauth2/v1/tokeninfo";return t.$apply(function(){a({method:"GET",url:i,params:{access_token:e}}).success(function(e){e.audience==o.clientId?r.resolve(e):r.reject({name:"invalid_audience"})}).error(function(o,e,a,t){r.reject({name:"error_response",data:o,status:e,headers:a,config:t})})}),r.promise}])}).config(["TokenProvider","GoogleTokenVerifier",function(o,e){o.extendConfig({authorizationEndpoint:"https://accounts.google.com/o/oauth2/auth",scopes:["https://www.googleapis.com/auth/userinfo.email"],verifyFunc:e})}]),angular.module("angularOauth",[]).provider("Token",function(){var o=function(o){var e=[];return angular.forEach(o,function(o,a){e.push(encodeURIComponent(a)+"="+encodeURIComponent(o))}),e.join("&")},e="token",a={},t={clientId:a,redirectUri:a,authorizationEndpoint:a,localStorageName:"accessToken",verifyFunc:a,scopes:[]};this.extendConfig=function(o){t=angular.extend(t,o)},this.$get=["$q","$http","$window","$rootScope",function(n,r,i,l){var s=[];if(angular.forEach(t,function(o,e){o===a&&s.push(e)}),s.length)throw new Error("TokenProvider is insufficiently configured.  Please configure the following options using TokenProvider.extendConfig: "+s.join(", "));if(!t.clientId)throw new Error("clientId needs to be configured using TokenProvider.");var c=function(){return{response_type:t.responseType||e,client_id:t.clientId,redirect_uri:t.redirectUri,scope:t.scopes.join(" ")}},d=function(e){var a=angular.extend(c(),e);return t.authorizationEndpoint+"?"+o(a)};return{get:function(){return localStorage[t.localStorageName]},set:function(o){localStorage[t.localStorageName]=o},clear:function(){localStorage.removeItem(t.localStorageName)},verifyAsync:function(o){return t.verifyFunc(t,o)},getTokenByPopup:function(o,e){e=angular.extend({name:"AuthPopup",openParams:{width:650,height:300,resizable:!0,scrollbars:!0,status:!0}},e);var a=n.defer(),t=d(o),r=function(o){var e=[];return angular.forEach(o,function(o,a){(o||0===o)&&(o=o===!0?"yes":o,e.push(a+"="+o))}),e.join(",")},s=window.open(t,e.name,r(e.openParams));return angular.element(i).bind("message",function(o){o=o.originalEvent||o,o.source==s&&o.origin==window.location.origin&&l.$apply(function(){o.data.access_token?a.resolve(o.data):a.reject(o.data)})}),a.promise},getTokenInSameWindow:function(o){var e=d(o);i.location.href=e}}}]}).controller("CallbackCtrl",["$scope","$location",function(o,e){function a(o){var e,a,t={};return angular.forEach((o||"").split("&"),function(o){o&&(e=o.split("="),a=decodeURIComponent(e[0]),t[a]=angular.isDefined(e[1])?decodeURIComponent(e[1]):!0)}),t}var t=e.path().substring(1),n=a(t);window.opener.postMessage(n,"*"),window.close()}]),angular.module("bolao").run(["$templateCache",function(o){o.put("components/navbar/navbar.html",'<nav class="navbar" ng-controller="NavbarCtrl"><a href="https://github.com/Swiip/generator-gulp-angular">Gulp Angular</a><ul><li class="active"><a ng-href="#">Home</a></li><li><a ng-href="#">About</a></li><li><a ng-href="#">Contact</a></li></ul><ul><li><a ng-href="#">Current date: {{ date | date:\'yyyy-MM-dd\' }}</a></li></ul></nav>'),o.put("components/acordeon/diretivas/diretiva-acordeon.html",'<div class="acordeon main" ng-transclude=""></div>'),o.put("components/acordeon/diretivas/diretiva-item.html",'<div class="item {{situacao}}"><div class="item-cabecalho {{situacao}} {{tipo}}" ng-click="abrir(indice)"><figure><img ng-src="{{boleiro.foto}}"> <img ng-src="assets/images/times/Flamengo.png"><figcaption>Meu campeão: 10 pontos</figcaption></figure><div class="nome">{{boleiro.boleiro}}</div><div class="valores">Pontos<br>{{boleiro.pontos}}</div><div class="valores">Placares<br>{{boleiro.placares}}</div></div><div ng-transclude=""></div></div>'),o.put("components/acordeon/diretivas/diretiva-menu.html",'<div class="{{menuActive}}"><header><span class="menu-anchor" ng-click="abrir()"></span><h1><a href="#">Bolão dos Combinados</a></h1></header><div ng-transclude="" class="menu-main"></div></div>'),o.put("components/acordeon/diretivas/diretiva-palpite.html",'<div><span ng-show="somenteLeitura">{{gols}}</span> <input ng-show="!somenteLeitura" type="number" min="0" ng-model="gols" stop-event="touchend click"></div>'),o.put("components/carrossel/diretivas/diretiva-carrossel.html",'<div class="carrossel"><nav class="navegacao"><ul class="pontos"><li class="ponto" ng-class="{\'ativo\':ehPaginaAtual($index + 1)}" ng-repeat="pagina in (0|number:totalPaginas - 2 ) track by $index" ng-click="atualizarPagina($index + 1);">{{$index + 1}}</li></ul></nav><div ng-transclude="" class="paginas {{direcao}}" ng-swipe-left="paginaAnterior()" ng-swipe-right="proximaPagina()"></div><a class="seta anterior" ng-click="paginaAnterior()"></a> <a class="seta proxima" ng-click="proximaPagina()"></a></div>'),o.put("components/carrossel/diretivas/diretiva-paginas.html",'<div class="pagina" ng-hide="!visivel"><div class="conteudo" ng-transclude="" ng-click="alternarDetalhe()"></div><div ng-click="alternarDetalhe()" class="detalhe" ng-class="{ocultar : !detalheVisivel}"><table class="detalhe-rodada"><tr><td class="cabecalho-detalhe-rodada" colspan="4">Detalhes da Rodada</td></tr><tr><td class="esquerda">Número:</td><td class="esquerda">{{conteudo.id}}</td><td class="esquerda">Total de Pontos:</td><td class="direita">{{conteudo.pontos}}</td></tr><tr><td class="esquerda">Data:</td><td class="esquerda">{{conteudo.data | date : \'dd/MM/yyyy\'}}</td><td class="esquerda">Total de Placares:</td><td class="direita">{{conteudo.placares}}</td></tr></table></div></div>')}]);